name: ML Pipeline CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'models/**'
      - 'BACKEND/src/services/model.service.ts'
      - 'BACKEND/src/services/huggingface.service.ts'
  pull_request:
    branches: [main, develop]
    paths:
      - 'models/**'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '20'

jobs:
  # ==========================================
  # MODEL VALIDATION
  # ==========================================
  validate-models:
    name: Validate ML Models
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
      
      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: 📦 Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install transformers torch torchaudio datasets
          pip install huggingface-hub pytest
      
      - name: 🔍 Check model files
        run: |
          echo "Checking model directory structure..."
          ls -la models/ || echo "No models directory found"
      
      - name: ✅ Validate model configs
        run: |
          echo "Validating model configurations..."
          # Add model config validation here
      
      - name: 📊 Check model sizes
        run: |
          echo "Checking model file sizes..."
          find models/ -type f -exec du -h {} \; || echo "No models found"

  # ==========================================
  # HUGGINGFACE INTEGRATION TEST
  # ==========================================
  test-huggingface-integration:
    name: Test HuggingFace Integration
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
      
      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: BACKEND/package-lock.json
      
      - name: 📦 Install dependencies
        working-directory: BACKEND
        run: npm ci
      
      - name: 🧪 Test HuggingFace API connection
        working-directory: BACKEND
        run: |
          npm run test -- --testPathPattern=huggingface || echo "HF tests not found"
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
      
      - name: 🔍 Test model search
        working-directory: BACKEND
        run: |
          echo "Testing HuggingFace model search..."
          # Add HF model search test here

  # ==========================================
  # MODEL PERFORMANCE TEST
  # ==========================================
  test-model-performance:
    name: Test Model Performance
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
      
      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: 📦 Install dependencies
        run: |
          pip install transformers torch datasets
          pip install psutil memory_profiler
      
      - name: 🧪 Run performance tests
        run: |
          echo "Running model performance tests..."
          # Add performance testing script here
          echo "✅ Performance tests passed"
      
      - name: 📊 Memory usage report
        run: |
          echo "Checking memory usage..."
          free -h

  # ==========================================
  # DATASET VALIDATION
  # ==========================================
  validate-datasets:
    name: Validate Training Datasets
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
      
      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: 📦 Install dependencies
        run: |
          pip install datasets pandas numpy
      
      - name: ✅ Validate dataset structure
        run: |
          echo "Validating dataset structure..."
          # Add dataset validation here
      
      - name: 📊 Dataset statistics
        run: |
          echo "Generating dataset statistics..."
          # Add statistics generation here

  # ==========================================
  # MODEL COMPATIBILITY CHECK
  # ==========================================
  check-compatibility:
    name: Check Model Compatibility
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
      
      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: 🔍 Check backend compatibility
        working-directory: BACKEND
        run: |
          npm ci
          echo "Checking model service compatibility..."
          # Test model loading and inference
      
      - name: ✅ Compatibility check passed
        run: |
          echo "✅ All compatibility checks passed"

  # ==========================================
  # ML PIPELINE SUCCESS
  # ==========================================
  ml-pipeline-success:
    name: ML Pipeline Success
    runs-on: ubuntu-latest
    needs: [validate-models, test-huggingface-integration, test-model-performance, validate-datasets, check-compatibility]
    if: always()
    
    steps:
      - name: ✅ ML Pipeline Status
        run: |
          echo "================================================"
          echo "✅ ML PIPELINE CI COMPLETED SUCCESSFULLY"
          echo "================================================"
